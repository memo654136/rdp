name: RDP

on:
  workflow_dispatch:

jobs:
  rdp-forever:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 ساعات = الحد الأقصى (GitHub يقتل بعدها)

    steps:
      - name: تفعيل RDP + فتح البورت
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Forever" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Forever" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: إنشاء مستخدم RDP (من Secrets)
        env:
          USER: ${{ secrets.RDP_USER }}
          PASS: ${{ secrets.RDP_PASS }}
        run: |
          if (-not $env:USER -or -not $env:PASS) {
            Write-Error "اضبطي RDP_USER و RDP_PASS في Secrets"
            exit 1
          }
          $sec = ConvertTo-SecureString $env:PASS -AsPlainText -Force
          if (-not (Get-LocalUser -Name $env:USER -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $env:USER -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $env:USER
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:USER
          }
          echo "RDP_USER=$env:USER" >> $env:GITHUB_ENV
          echo "RDP_PASS=$env:PASS" >> $env:GITHUB_ENV

      - name: تثبيت Tailscale
        env:
          KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale_latest_amd64.msi"
          $path = "$env:TEMP\tailscale.msi"
          iwr $url -OutFile $path
          msiexec /i "$path" /quiet /norestart | Out-Null
          Remove-Item $path -Force

          $hostname = "my-rdp-forever"  # نفس الاسم = نفس الـ IP دايمًا
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=$env:KEY `
            --hostname=$hostname `
            --accept-routes `
            --accept-dns=false

          # انتظري الـ IP
          $ip = $null
          for ($i = 0; $i -lt 15 -and -not $ip; $i++) {
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 | Select -First 1
            if (-not $ip) { Start-Sleep -Seconds 4 }
          }
          if (-not $ip) { Write-Error "Tailscale فشل" ; exit 1 }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "IP ثابت: $ip"

      - name: عرض بيانات الاتصال (مرة واحدة)
        run: |
          Write-Host "`n"
          Write-Host "============================================"
          Write-Host "           RDP جاهز ومش هيفصل!"
          Write-Host "   العنوان: $($env:TAILSCALE_IP)"
          Write-Host "   المستخدم: $($env:RDP_USER)"
          Write-Host "   كلمة المرور: $($env:RDP_PASS)"
          Write-Host "   الجلسة: 6 ساعات (ثم أعدي التشغيل)"
          Write-Host "============================================"
          Write-Host "`n[$(Get-Date)] الجلسة شغالة... (لا تُغلق الصفحة)"

      - name: ابقي الجلسة شغالة إلى الأبد (حتى 6 ساعات)
        run: |
          $start = Get-Date
          while ($true) {
            $elapsed = (Get-Date) - $start
            $remain = 360 - [math]::Floor($elapsed.TotalMinutes)
            if ($remain -le 0) { break }
            Write-Host "[$(Get-Date -f 'HH:mm:ss')] شغالة... باقي $remain دقيقة (أعدي التشغيل لاحقًا)"
            Start-Sleep -Seconds 60
          }
          Write-Host "انتهت 6 ساعات. أعدي تشغيل الـ Workflow مرة تانية!"
